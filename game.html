<!DOCTYPE html>
<html lang="en">
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <meta content="utf-8" http-equiv="encoding" />
  </head>
  <body tabindex="1">
    <canvas id="gameCanvas" width="800" height="600" tabindex="2"></canvas>
    <script defer="true">
      const carPic = document.createElement('img');
      let carPicLoaded = false;

      const CAR_SIZE = 14;
      const CAR_RADIUS = CAR_SIZE / 2;
      const TRACK_W = 40;
      const TRACK_H = 40;
      const TRACK_COLS = 20;
      const TRACK_ROWS = 15;
      const TRACK_GAP = 2;

      const TRACK = {
        ROAD: 0,
        WALL: 1,
        PLAYER_START: 2,
      };

      // prettier-ignore
      const trackGrid = [
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1,
        1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1,
        1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 1,
        1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1,
        1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1,
        1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
        1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
        1, 0, 2, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1,
        1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1
      ];

      let carX = 175;
      let carY = 175;
      let carAngle = 0;
      let carSpeed = 0;

      const GROUND_SPEED_DECAY_MULT = 0.95;
      const DRIVE_POWER = 0.4;
      const REVERSE_POWER = 0.3;
      const TURN_RATE = 0.05;

      let canvas, canvasContext;
      let mouseX = 0;
      let mouseY = 0;

      const KEYS = {
        ARROWS: {
          LEFT: 37,
          UP: 38,
          RIGHT: 39,
          DOWN: 40,
        },
      };

      const keyHeld = {
        gas: false,
        reverse: false,
        turnLeft: false,
        turnRight: false,
      };

      function colRowToIndex(col, row) {
        return TRACK_COLS * row + col;
      }

      function posXToCol(posX) {
        return Math.floor(posX / TRACK_W);
      }

      function posYToRow(posY) {
        return Math.floor(posY / TRACK_H);
      }

      function carReset() {
        for (let row = 0; row < TRACK_ROWS; row++) {
          for (let col = 0; col < TRACK_COLS; col++) {
            const index = colRowToIndex(col, row);

            if (trackGrid[index] === TRACK.PLAYER_START) {
              trackGrid[index] = TRACK.ROAD;
              carAngle = -Math.PI / 2;
              carX = col * TRACK_W + TRACK_W / 2;
              carY = row * TRACK_H + TRACK_H / 2;
            }
          }
        }
      }

      function keyPressed(event) {
        if (event.keyCode === KEYS.ARROWS.LEFT) {
          keyHeld.turnLeft = true;
        }
        if (event.keyCode === KEYS.ARROWS.RIGHT) {
          keyHeld.turnRight = true;
        }
        if (event.keyCode === KEYS.ARROWS.UP) {
          keyHeld.gas = true;
        }
        if (event.keyCode === KEYS.ARROWS.DOWN) {
          keyHeld.reverse = true;
        }
      }

      function keyReleased(event) {
        if (event.keyCode === KEYS.ARROWS.LEFT) {
          keyHeld.turnLeft = false;
        }
        if (event.keyCode === KEYS.ARROWS.RIGHT) {
          keyHeld.turnRight = false;
        }
        if (event.keyCode === KEYS.ARROWS.UP) {
          keyHeld.gas = false;
        }
        if (event.keyCode === KEYS.ARROWS.DOWN) {
          keyHeld.reverse = false;
        }
      }

      window.onload = function () {
        canvas = document.getElementById('gameCanvas');
        canvasContext = canvas.getContext('2d');

        let framesPerSecond = 30;

        setInterval(updateAll, 1000 / framesPerSecond);

        canvas.addEventListener('mousemove', updateMousePos);
        document.addEventListener('keydown', keyPressed);
        document.addEventListener('keyup', keyReleased);

        carPic.onload = function () {
          carPicLoaded = true;
        };

        carPic.src = 'player1car.png';

        carReset();
      };

      function updateMousePos(evt) {
        const rect = canvas.getBoundingClientRect();
        const root = document.documentElement;

        mouseX = evt.clientX - rect.left - root.scrollLeft;
        mouseY = evt.clientY - rect.top - root.scrollTop;
      }

      function carMove() {
        carSpeed *= GROUND_SPEED_DECAY_MULT;

        if (keyHeld.gas) {
          carSpeed += DRIVE_POWER;
        }
        if (keyHeld.reverse) {
          carSpeed -= REVERSE_POWER;
        }
        if (keyHeld.turnLeft) {
          carAngle -= TURN_RATE;
        }
        if (keyHeld.turnRight) {
          carAngle += TURN_RATE;
        }

        carX = carX + Math.cos(carAngle) * carSpeed;
        carY = carY + Math.sin(carAngle) * carSpeed;
      }

      function isWallAtColRow(col, row) {
        if (col >= 0 && col < TRACK_COLS && row >= 0 && row < TRACK_ROWS) {
          const trackIndex = colRowToIndex(col, row);

          return trackGrid[trackIndex] === TRACK.WALL;
        }
        return false;
      }

      function carTrackHandler() {
        const carTrackCol = posXToCol(carX);
        const carTrackRow = posYToRow(carY);
        const index = colRowToIndex(carTrackCol, carTrackRow);

        if (
          carTrackCol >= 0 &&
          carTrackCol < TRACK_COLS &&
          carTrackRow >= 0 &&
          carTrackRow < TRACK_ROWS
        ) {
          if (isWallAtColRow(carTrackCol, carTrackRow)) {
            carSpeed *= -0.5;
          }
        }
      }

      function moveAll() {
        carMove();
        carTrackHandler();
      }

      function drawBitMapCenteredWithRotation(bitMap, atX, atY, angle) {
        canvasContext.save();
        canvasContext.translate(atX, atY);
        canvasContext.rotate(angle);
        canvasContext.drawImage(
          bitMap,
          (-1 * bitMap.width) / 2,
          (-1 * bitMap.height) / 2
        );
        canvasContext.restore();
      }

      function colorRect(topLeftX, topLeftY, boxWidth, boxHeight, fillColor) {
        canvasContext.fillStyle = fillColor;
        canvasContext.fillRect(topLeftX, topLeftY, boxWidth, boxHeight);
      }

      function colorCircle(centerX, centerY, radius, fillColor) {
        canvasContext.fillStyle = fillColor;
        canvasContext.beginPath();
        canvasContext.arc(centerX, centerY, radius, 0, Math.PI * 2, true);
        canvasContext.fill();
      }

      function colorText(words, textX, textY, fillColor) {
        canvasContext.fillStyle = fillColor;
        canvasContext.fillText(words, textX, textY);
      }

      function drawTracks() {
        for (let row = 0; row < TRACK_ROWS; row++) {
          for (let col = 0; col < TRACK_COLS; col++) {
            const index = colRowToIndex(col, row);

            if (trackGrid[index] === TRACK.WALL) {
              colorRect(
                TRACK_W * col,
                TRACK_H * row,
                TRACK_W - TRACK_GAP,
                TRACK_H - TRACK_GAP,
                'blue'
              );
            }
          }
        }
      }

      function logData() {
        const mouseTrackCol = Math.floor(mouseX / TRACK_W);
        const mouseTrackRow = Math.floor(mouseY / TRACK_H);
        const index = colRowToIndex(mouseTrackCol, mouseTrackRow);
        colorText(
          `i=${index};b=${mouseTrackCol},${mouseTrackRow};c=${mouseX},${mouseY}`,
          mouseX,
          mouseY,
          'yellow'
        );
      }

      function drawAll() {
        colorRect(0, 0, canvas.width, canvas.height, 'black');

        if (carPicLoaded) {
          drawBitMapCenteredWithRotation(carPic, carX, carY, carAngle);
        }

        drawTracks();
        logData();
      }

      function updateAll() {
        moveAll();
        drawAll();
      }
    </script>
  </body>
</html>
